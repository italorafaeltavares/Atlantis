version: 3 
automerge: true
projects:
  - name: main
    dir: .
    autoplan:
      enabled: true
      when_modified: ["*.hcl", "*.tf", "*.tfvars"]
    workflow: terragrunt-workflow

workflows:
  terragrunt-workflow:
    plan:
      steps:
        - env:
            name: TERRAGRUNT_TFPATH
            command: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
        - env:
            name: TF_IN_AUTOMATION
            value: 'true'
        - run:
            command: terragrunt plan --terragrunt-working-dir=. -input=false -out=planfile.tfplan
            output: strip_refreshing
    apply:
      steps:
        - env:
            name: TERRAGRUNT_TFPATH
            command: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
        - env:
            name: TF_IN_AUTOMATION
            value: 'true'
        - run:
            command: terragrunt apply --terragrunt-working-dir=. planfile.tfplan --auto-approve
