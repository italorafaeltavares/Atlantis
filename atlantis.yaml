version: 3

automerge: true

projects:
  - name: main
    dir: .
    autoplan:
      enabled: true
      when_modified: ["*.hcl", "*.tf", "*.tfvars"]
    workflow: terragrunt-workflow

workflows:
  terragrunt-workflow:
    plan:
      steps:
        - env:
            name: TERRAGRUNT_TFPATH
            command: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
        - env:
            # Reduz a saída de sugestões do Terraform
            name: TF_IN_AUTOMATION
            value: 'true'
        - run:
            command: terragrunt plan --terragrunt-working-dir=. -input=false -out=$PLANFILE
            output: strip_refreshing
    apply:
      steps:
        - env:
            name: TERRAGRUNT_TFPATH
            command: 'echo "terraform${ATLANTIS_TERRAFORM_VERSION}"'
        - env:
            # Reduz a saída de sugestões do Terraform
            name: TF_IN_AUTOMATION
            value: 'true'
        - run:
            command: terragrunt apply --terragrunt-working-dir=. $PLANFILE --auto-approve
